<!doctype html>
<html>

<head>
  <title>Link</title>
  <link rel="icon" href="assets/graphics/link_icon_w_on_g.png">
  <link rel="stylesheet" type="text/css" href="assets/css/dashboard.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>
  <script src="assets/js/dashboard.js"></script>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
</head>

<script>
$.getJSON("api/user_data", function(data) {
    // Make sure the data contains the username as expected before using it
        console.log(data.user);
        if (data.user.items.length != 0) {
            $.get('/api/get_cached_transactions').success(
                function(success) {
                    if (success != null) {
                        addCards(success);
                        addTransactions(success);
                    } else {
                        console.log("Im null and need to refresh");
                        $.get('/api/refresh_cache');
                        setTimeout(function() {
                            console.log("I'm running");
                            $.get('/api/get_cached_transactions').success(
                                function(success_transactions) {
                                    if (success_transactions != null) {
                                        addCards(success_transactions);
                                        addTransactions(success_transactions);
                                    }
                                    console.log(success_transactions);
                                }).error(
                                function(error) {
                                    console.log(error)
                                });
                        }, 3000);
                    }
                    console.log(success);
                }).error(
                function(error) {
                    console.log(error);
                });
        } else {
            console.log("Loaded");
            var new_card = document.createElement('div');
            new_card.innerHTML = 'Link an account by pressing the + below'
            document.getElementById('container_block').appendChild(new_card);
            //Tell Grey thingy that nothing is going to load or render it idk
        }
    });

</script>

<body>
    <div class="top-bar">
        <div class="logo">
            <a href="/"><img src="assets/graphics/link_brand_white.png" width="120px" style="float: left; "></a>
        </div class>
        <div class="nav-bar">
            <a href="/dashboard">Dashboard</a>
            <!-- <a href="/workinprogress">Business</a>
      <a href="/workinprogress">About</a>-->
            <a href="/api/logout" id="logout">Logout</a>
            <a id="pro-button" href="/workinprogress">Link Pro</a>
        </div>
    </div>
  </div>
  <div class="white-body">
    <div class="content" id="container_block">
      <button id="link-btn"><img src="assets/graphics/add.svg"></button>
      <!-- accounts cards get inserted here in the javascript -->
    </div>
  </div>

  <script>
  var handler = Plaid.create({
      apiVersion: 'v2',
      clientName: 'Plaid Walkthrough Demo',
      env: '<%= PLAID_ENV %>',
      product: ['transactions'],
      key: '<%= PLAID_PUBLIC_KEY %>',
      onSuccess: function(public_token) {
        $.post('/get_access_token', {
          public_token: public_token
        }, function() {
          $('#container').fadeOut('fast', function() {
            $('#intro').hide();
            $('#app, #steps').fadeIn('slow');
          });
        });
      },
  });

  $('#link-btn').on('click', function(e) {
      handler.open();
  });
  </script>
</body>

</html>
